{% extends "base.html" %}

{% block title %}–ß–∞—Ç - Synaps{% endblock %}

{% block content %}
    
    <div id="content-wrapper" data-current-user-id="{{ current_user.id }}">

        <div id="user-list-container">
            <h3>–ö–æ—Ä–∏—Å—Ç—É–≤–∞—á—ñ Synaps</h3>
            <ul id="user-list">
                {% for user in users %}
                    <li class="user-item" data-id="{{ user.id }}" data-username="{{ user.username }}">
                        {{ user.username }}
                    </li>
                {% endfor %}
            </ul>
        </div>

        <div id="chat_window">
            <h3 id="chat-with-title">–ë—É–¥—å –ª–∞—Å–∫–∞, –æ–±–µ—Ä—ñ—Ç—å —á–∞—Ç</h3>
            <ul id="messages">
                </ul>
            
            <div id="form">
                <input type="file" id="file_input" accept="image/*" style="display: none;">
                <label for="file_input" id="file_button">üìé</label>
                
                <input id="message_input" autocomplete="off" placeholder="–û–±–µ—Ä—ñ—Ç—å —á–∞—Ç..." disabled />
                <button id="send_button" disabled>–í—ñ–¥–ø—Ä–∞–≤–∏—Ç–∏</button>
            </div>
            
        </div>

    </div> <script src="https://cdn.socket.io/4.7.5/socket.io.min.js"></script>
    <script>
        // === –ì–õ–û–ë–ê–õ–¨–ù–Ü –ó–ú–Ü–ù–ù–Ü ===
        const chatHistories = {};
        const wrapper = document.getElementById('content-wrapper');
        const currentUserId = parseInt(wrapper.dataset.currentUserId, 10);
        const currentUsername = "{{ current_user.username }}";
        
        let activeChatRecipientId = null; 
        let activeUserItem = null; 

        // === –ï–õ–ï–ú–ï–ù–¢–ò ===
        const socket = io();
        const messages = document.getElementById('messages');
        const input = document.getElementById('message_input');
        const sendButton = document.getElementById('send_button');
        const userList = document.getElementById('user-list');
        const chatTitle = document.getElementById('chat-with-title');
        const fileInput = document.getElementById('file_input');
        const fileButton = document.getElementById('file_button');

        // ===========================================
        // === –õ–û–ì–Ü–ö–ê: –ö–õ–Ü–ö–ò –¢–ê –ó–ú–Ü–ù–ò –ß–ê–¢–Ü–í ===
        // ===========================================

        userList.addEventListener('click', function(e) {
            const clickedUser = e.target.closest('.user-item');
            if (!clickedUser) return;
            
            const newRecipientId = clickedUser.dataset.id;
            const newUsername = clickedUser.dataset.username;

            if (newRecipientId == activeChatRecipientId) return; 

            if (activeUserItem) {
                activeUserItem.classList.remove('active');
            }

            activeChatRecipientId = newRecipientId;
            activeUserItem = clickedUser;
            activeUserItem.classList.add('active');

            chatTitle.innerText = '–ß–∞—Ç –∑: ' + newUsername;
            input.placeholder = '–ù–∞–ø–∏—à—ñ—Ç—å ' + newUsername + '...';
            input.disabled = false;
            sendButton.disabled = false;
            fileButton.classList.add('active'); // –†–æ–±–∏–º–æ "—Å–∫—Ä—ñ–ø–∫—É" –∞–∫—Ç–∏–≤–Ω–æ—é

            if (chatHistories[activeChatRecipientId]) {
                renderChatHistory(activeChatRecipientId);
            } else {
                messages.innerHTML = '<li class="status">–ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è —ñ—Å—Ç–æ—Ä—ñ—ó...</li>';
                socket.emit('load_history', { 'partner_id': activeChatRecipientId });
            }
        });
        
        function renderChatHistory(chatPartnerId) {
            messages.innerHTML = '';
            const history = chatHistories[chatPartnerId] || [];
            
            if (history.length === 0) {
                 messages.innerHTML = '<li class="status">–ü–æ–≤—ñ–¥–æ–º–ª–µ–Ω—å —â–µ –Ω–µ–º–∞—î.</li>';
                 return;
            }
            
            for (const msg of history) {
                renderMessage(msg, false); 
            }
            scrollToBottom(); 
        }
        
        function renderMessage(msgData, shouldScroll = true) {
            const item = document.createElement('li');
            const timestamp = new Date(msgData.timestamp);
            const formattedTime = timestamp.toLocaleString('uk-UA', { 
                hour: '2-digit', minute: '2-digit', 
                day: '2-digit', month: 'short' 
            });

            if (msgData.sender_id == currentUserId) {
                item.classList.add('my-message');
            }
            
            // === –†–µ–Ω–¥–µ—Ä–∏–º–æ —Ñ–æ—Ç–æ –∞–±–æ —Ç–µ–∫—Å—Ç ===
            let messageContent;
            if (msgData.is_image) {
                messageContent = `<img src="${msgData.image_url}" alt="–ó–æ–±—Ä–∞–∂–µ–Ω–Ω—è" class="chat-image">`;
            } else {
                messageContent = msgData.text; // msgData.text –º–æ–∂–µ –±—É—Ç–∏ null, –∞–ª–µ JS –≤–ø–æ—Ä–∞—î—Ç—å—Å—è
            }

            item.innerHTML = `
                <strong>${msgData.sender_username}:</strong> 
                ${messageContent}
                <span class="timestamp">${formattedTime}</span>
            `;
            
            messages.appendChild(item);
            
            if (shouldScroll) {
                scrollToBottom();
            }
        }
        
        function scrollToBottom() {
            messages.scrollTop = messages.scrollHeight;
        }

        // ===========================================
        // === –õ–û–ì–Ü–ö–ê: SOCKET.IO –¢–ê –í–Ü–î–ü–†–ê–í–ö–ê ===
        // ===========================================

        // –í—ñ–¥–ø—Ä–∞–≤–∫–∞ –¢–ï–ö–°–¢–£
        function sendMessage() {
            const text = input.value.trim();
            if (!text || !activeChatRecipientId) { 
                return; 
            }
            socket.emit('send_message', {
                'text': text,
                'recipient_id': activeChatRecipientId
            });
            input.value = "";
        }

        sendButton.onclick = sendMessage;
        input.addEventListener('keypress', function (e) {
            if (e.key === 'Enter') sendMessage();
        });
        
        // –í—ñ–¥–ø—Ä–∞–≤–∫–∞ –§–û–¢–û
        fileInput.addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (!file || !activeChatRecipientId) {
                return;
            }
            
            const formData = new FormData();
            formData.append('file', file);
            formData.append('recipient_id', activeChatRecipientId);
            
            renderMessage({
                sender_id: currentUserId,
                sender_username: currentUsername,
                text: "<i>–ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è —Ñ–æ—Ç–æ...</i>",
                is_image: false,
                timestamp: new Date().toISOString()
            }, true);

            fetch('/upload', {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    console.log('Upload success');
                    // –°–µ—Ä–≤–µ—Ä —Å–∞–º –Ω–∞–¥—ñ—à–ª–µ 'new_message', 
                    // —Ç–æ–º—É "–∑–∞–≥–ª—É—à–∫–∞" –ø—Ä–æ—Å—Ç–æ –∑–∞–º—ñ–Ω–∏—Ç—å—Å—è
                } else {
                    alert('–ü–æ–º–∏–ª–∫–∞ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è: ' + data.error);
                }
            })
            .catch(error => {
                console.error('Fetch error:', error);
                alert('–ö—Ä–∏—Ç–∏—á–Ω–∞ –ø–æ–º–∏–ª–∫–∞ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è.');
            });
            e.target.value = null;
        });

        // === –û–ë–†–û–ë–ö–ê –í–•–Ü–î–ù–ò–• ===
        socket.on('new_message', function(data) {
            let chatPartnerId;
            if (data.sender_id == currentUserId) {
                chatPartnerId = data.recipient_id;
            } else {
                chatPartnerId = data.sender_id;
            }
            
            if (!chatHistories[chatPartnerId]) {
                chatHistories[chatPartnerId] = [];
            }
            chatHistories[chatPartnerId].push(data);
            
            if (chatPartnerId == activeChatRecipientId) {
                if (messages.querySelector('.status')) {
                    messages.innerHTML = '';
                }
                renderMessage(data, true);
            }
        });
        
        socket.on('history_loaded', function(data) {
            const partnerId = data.partner_id;
            chatHistories[partnerId] = data.history;
            if (partnerId == activeChatRecipientId) {
                renderChatHistory(partnerId);
            }
        });
    </script>
    
    <style>
        #content-wrapper { display: flex; gap: 20px; }
        #user-list-container {
            flex-basis: 30%; min-width: 180px;
            border: 1px solid #ccc; border-radius: 5px;
            background: #fff; height: fit-content; max-height: 500px;
            display: flex; flex-direction: column;
        }
        #chat_window { flex-basis: 70%; display: flex; flex-direction: column; }
        #user-list-container h3 {
            margin: 0; padding: 10px 15px; background: #f7f7f7;
            border-bottom: 1px solid #ccc;
        }
        #user-list { list-style: none; padding: 0; margin: 0; overflow-y: auto; }
        .user-item {
            padding: 10px 15px; border-bottom: 1px solid #eee;
            cursor: pointer; font-weight: 500;
        }
        .user-item:last-child { border-bottom: none; }
        .user-item:hover { background: #f0f0f0; }
        .user-item.active { background: #e0eafc; font-weight: bold; color: #0056b3; } 
        #chat_window h3 {
            padding: 10px 15px; margin: 0; background: #f7f7f7;
            border: 1px solid #ccc; border-bottom: none;
            border-radius: 5px 5px 0 0;
        }
        #messages { 
            list-style-type: none; margin: 0; padding: 10px; 
            border: 1px solid #ccc; height: 300px; 
            overflow-y: scroll; background: #fff; 
            border-radius: 0 0 5px 5px;
            flex-grow: 1;
        }
        #messages li { 
            padding: 8px 12px; margin-bottom: 10px; 
            max-width: 80%; width: fit-content;
            border-radius: 10px;
            position: relative; 
            word-wrap: break-word; 
        }
        #messages li.my-message {
            background-color: #007bff; color: white;
            margin-left: auto; text-align: left; 
        }
        #messages li:not(.my-message) { background: #f0f0f0; }
        #messages li strong { margin-right: 5px; display: block; font-size: 0.9em; }
        #messages li.my-message strong { display: none; }
        #messages li.status { 
            font-style: italic; color: #888; text-align: center;
            background: none; margin-left: auto; margin-right: auto;
        }
        .timestamp {
            font-size: 0.75em; color: #777;
            display: block; margin-top: 5px; text-align: right;
        }
        #messages li.my-message .timestamp { color: #e0e0e0; }
        
        .chat-image {
            max-width: 100%; 
            border-radius: 5px;
            margin-top: 5px;
        }
        #messages li.my-message img { background: white; } 
        
        #form { display: flex; margin-top: 10px; width: 100%; }
        #file_button {
            padding: 10px 15px;
            border: 1px solid #ccc;
            border-right: none;
            border-radius: 3px 0 0 3px;
            font-size: 1.2em;
            cursor: not-allowed;
            background: #f4f4f4;
            color: #aaa;
        }
        #file_button.active {
            cursor: pointer;
            background: #eee;
            color: #333;
        }
        #file_button.active:hover { background: #ddd; }
        
        #message_input { 
            flex-grow: 1; padding: 10px; border: 1px solid #ccc; 
            border-radius: 0;
            border-left: none;
        }
        #send_button { 
            padding: 10px 20px; background: #007bff; color: white; 
            border: none; border-radius: 0 3px 3px 0; 
        }
        #send_button:hover { background: #0056b3; }
        #message_input:disabled, #send_button:disabled {
            background-color: #f4f4f4;
            cursor: not-allowed;
        }
    </style>
{% endblock %}